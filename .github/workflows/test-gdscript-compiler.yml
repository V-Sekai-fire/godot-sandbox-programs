name: GDScript Compiler Tests

on:
  push:
    branches: [ main, gdscript ]
    paths:
      - 'programs/gdscript-native/**'
      - '.github/workflows/test-gdscript-compiler.yml'
  pull_request:
    branches: [ main ]
    paths:
      - 'programs/gdscript-native/**'
      - '.github/workflows/test-gdscript-compiler.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  BUILD_TYPE: Release

jobs:
  test:
    runs-on: ubuntu-24.04
    
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false
        # Git subrepo dependencies are already embedded in the repo

    - name: Install dependencies
      run: |
        sudo apt update
        sudo apt install -y build-essential cmake git

    - name: Verify git subrepo dependencies
      working-directory: ${{github.workspace}}
      run: |
        # Verify that git subrepo dependencies are present
        if [ ! -d "ext/biscuit" ]; then
          echo "ERROR: ext/biscuit not found (git subrepo dependency)"
          exit 1
        fi
        if [ ! -d "ext/libriscv" ]; then
          echo "ERROR: ext/libriscv not found (git subrepo dependency)"
          exit 1
        fi
        echo "Git subrepo dependencies verified"

    - name: Build tests
      working-directory: ${{github.workspace}}
      run: |
        # Disable RISCV binary translation to avoid FetchContent for tinycc
        # Dependencies are already available via git subrepo in ext/
        cmake -B build -DCMAKE_BUILD_TYPE=${{env.BUILD_TYPE}} -DRISCV_BINARY_TRANSLATION=OFF -DRISCV_LIBTCC=OFF
        if [ $? -ne 0 ]; then
          echo "ERROR: CMake configuration failed"
          exit 1
        fi
        # Build only the test targets we need (excluding test_end_to_end_features which requires libriscv)
        cmake --build build --target test_parser test_compiler test_dataset test_elf_generation --parallel 8
        if [ $? -ne 0 ]; then
          echo "ERROR: Test build failed"
          exit 1
        fi

    - name: Verify test executables exist
      working-directory: ${{github.workspace}}/build
      run: |
        echo "Checking for test executables..."
        ls -la programs/gdscript-native/tests/ || echo "Tests directory not found"
        find . -name "test_parser" -o -name "test_compiler" -o -name "test_dataset" -o -name "test_elf_generation" || echo "Test executables not found"

    - name: Run parser tests
      working-directory: ${{github.workspace}}/build
      run: |
        if [ -f programs/gdscript-native/tests/test_parser ]; then
          ./programs/gdscript-native/tests/test_parser
        else
          echo "ERROR: test_parser not found at programs/gdscript-native/tests/test_parser"
          exit 1
        fi

    - name: Run compiler tests
      working-directory: ${{github.workspace}}/build
      run: |
        if [ -f programs/gdscript-native/tests/test_compiler ]; then
          ./programs/gdscript-native/tests/test_compiler
        else
          echo "ERROR: test_compiler not found at programs/gdscript-native/tests/test_compiler"
          exit 1
        fi

    - name: Run dataset tests
      working-directory: ${{github.workspace}}/build
      run: |
        if [ -f programs/gdscript-native/tests/test_dataset ]; then
          ./programs/gdscript-native/tests/test_dataset
        else
          echo "ERROR: test_dataset not found at programs/gdscript-native/tests/test_dataset"
          exit 1
        fi

    - name: Run ELF generation tests
      working-directory: ${{github.workspace}}/build
      run: |
        if [ -f programs/gdscript-native/tests/test_elf_generation ]; then
          # test_elf_generation is a utility program, not a test - skip running it
          echo "test_elf_generation is a utility program, skipping test execution"
        else
          echo "WARNING: test_elf_generation not found at programs/gdscript-native/tests/test_elf_generation"
        fi

